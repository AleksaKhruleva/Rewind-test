name: Update PR Title with Tracker Link

on:
  pull_request:
    types:
      - opened

jobs:
  update-pr-title:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write  # –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ PR

    steps:
      - name: Extract issue key from PR title
        id: extract_issue_key
        run: |
          echo "üìå Pull request title: ${{ github.event.pull_request.title }}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "REWIND-{—á–∏—Å–ª–æ}", –≥–¥–µ —á–∏—Å–ª–æ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0
          if [[ "${{ github.event.pull_request.title }}" =~ ^(REWIND-[1-9][0-9]*): ]]; then
            ISSUE_KEY="${BASH_REMATCH[1]}"
            echo "üîë –ù–∞–π–¥–µ–Ω –∫–ª—é—á –∑–∞–¥–∞—á–∏: $ISSUE_KEY"
            echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
          else
            echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–≥–æ–ª–æ–≤–æ–∫ PR –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 'REWIND-{—á–∏—Å–ª–æ}:' (–≥–¥–µ —á–∏—Å–ª–æ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0)"
            exit 1
          fi

      - name: Update PR Title with Clickable Tracker Link
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_KEY: ${{ env.ISSUE_KEY }}
          TRACKER_URL: "https://tracker.yandex.ru"  # –ò–∑–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π URL
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
          TASK_URL="$TRACKER_URL/$ISSUE_KEY"
          CLICKABLE_KEY="[$ISSUE_KEY]($TASK_URL)"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
          if [[ "$PR_TITLE" != *"$CLICKABLE_KEY"* ]]; then
            # –ó–∞–º–µ–Ω—è–µ–º ISSUE_KEY –Ω–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
            UPDATED_TITLE="${PR_TITLE/$ISSUE_KEY/$CLICKABLE_KEY}"

            echo "üîó –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ PR: $UPDATED_TITLE"
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ PR —á–µ—Ä–µ–∑ GitHub API
            curl -X PATCH -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER" \
              -d "{\"title\": \"$UPDATED_TITLE\"}"
          else
            echo "‚úÖ –°—Å—ã–ª–∫–∞ —É–∂–µ –µ—Å—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ PR."
          fi
