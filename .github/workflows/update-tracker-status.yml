name: Update Tracker Status to Review

on:
  pull_request:
    types:
      - opened
      - reopened

jobs:
  update-status:
    runs-on: ubuntu-latest

    steps:
      - name: Log target branch
        run: |
          echo "üìå Target branch: ${{ github.event.pull_request.base.ref }}"

      - name: Extract issue key from PR title
        id: extract_issue_key
        run: |
          echo "üìå Pull request title: ${{ github.event.pull_request.title }}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "REWIND-{—á–∏—Å–ª–æ}", –≥–¥–µ —á–∏—Å–ª–æ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0
          if [[ "${{ github.event.pull_request.title }}" =~ ^(REWIND-[1-9][0-9]*): ]]; then
            ISSUE_KEY="${BASH_REMATCH[1]}"
            echo "üîë –ù–∞–π–¥–µ–Ω –∫–ª—é—á –∑–∞–¥–∞—á–∏: $ISSUE_KEY"
            echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
          else
            echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–≥–æ–ª–æ–≤–æ–∫ PR –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 'REWIND-{—á–∏—Å–ª–æ}:' (–≥–¥–µ —á–∏—Å–ª–æ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0)"
            exit 1
          fi

      - name: Update Tracker Task to "In Review"
        env:
          YANDEX_TRACKER_TOKEN: ${{ secrets.YANDEX_TRACKER_TOKEN }}
          YANDEX_CLOUD_ORG_ID: ${{ secrets.YANDEX_CLOUD_ORG_ID }}
          ISSUE_KEY: ${{ env.ISSUE_KEY }}
          TRANSITION_ID: "inReview1"
        run: |
          if [ -z "$ISSUE_KEY" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: ISSUE_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi

          echo "‚ÑπÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ $ISSUE_KEY –¥–æ —Å—Ç–∞—Ç—É—Å–∞ '–í —Ä–µ–≤—å—é'..."
          
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST "https://api.tracker.yandex.net/v2/issues/$ISSUE_KEY/transitions/$TRANSITION_ID/_execute" \
            -H "Authorization: OAuth $YANDEX_TRACKER_TOKEN" \
            -H "X-Cloud-Org-ID: $YANDEX_CLOUD_ORG_ID")

          if [ "$RESPONSE" -ne 200 ]; then
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏. –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: $RESPONSE"
            cat response.txt
            exit 1
          else
            echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ $ISSUE_KEY –¥–æ '–í —Ä–µ–≤—å—é'"
          fi
