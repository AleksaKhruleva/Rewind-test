name: Update Task Status on PR Close and Merge

on:
  pull_request:
    types:
      - closed  # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ PR –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è

jobs:
  update-task-status-on-pr-close:  # –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check if PR Was Merged or Not Merged
        id: check_merged_or_not
        run: |
          echo "üìå PR merged? ${{ github.event.pull_request.merged }}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ PR —Å–ª–∏—Ç
          if [[ "${{ github.event.pull_request.merged }}" != "true" ]]; then
            echo "‚ùå PR –∑–∞–∫—Ä—ã—Ç, –Ω–æ –Ω–µ –±—ã–ª —Å–ª–∏—Ç. –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ 'inProgress'."
            echo "status=inProgress" >> $GITHUB_ENV  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "inProgress"
          else
            echo "‚úÖ PR –±—ã–ª —Å–ª–∏—Ç (merged). –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ 'Merged'."
            echo "status=merged" >> $GITHUB_ENV  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "merged"
          fi

      - name: Validate PR Title Format and Extract ISSUE_KEY
        id: check_pr_title
        shell: bash
        run: |
          echo "üìå Validating PR title: ${{ github.event.pull_request.title }}"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á –∑–∞–¥–∞—á–∏
          if [[ "${{ github.event.pull_request.title }}" =~ ^(REWIND-[1-9][0-9]*): ]]; then
            ISSUE_KEY="${BASH_REMATCH[1]}"
            echo "üîë Extracted ISSUE_KEY: $ISSUE_KEY"
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º ISSUE_KEY –≤ —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
            echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
          else
            echo "‚ùå Invalid PR title format. Expected 'REWIND-{number}: description'"
            exit 1
          fi

      - name: Update Task Status Based on PR Merge Status
        run: |
          if [ -z "${{ env.ISSUE_KEY }}" ]; then
            echo "‚ùå ISSUE_KEY not found!"
            exit 1
          fi

          if [ "${{ env.status }}" == "inProgress" ]; then
            echo "‚ÑπÔ∏è Updating task ${{ env.ISSUE_KEY }} to 'inProgress' status..."
            RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST "https://api.tracker.yandex.net/v2/issues/${{ env.ISSUE_KEY }}/transitions/inProgress/_execute" \
              -H "Authorization: OAuth ${{ secrets.YANDEX_TRACKER_TOKEN }}" \
              -H "X-Cloud-Org-ID: ${{ secrets.YANDEX_CLOUD_ORG_ID }}")

            if [ "$RESPONSE" -ne 200 ]; then
              echo "‚ùå Error updating task. Response code: $RESPONSE"
              cat response.txt
              exit 1
            else
              echo "‚úÖ Task updated to 'inProgress' status successfully"
            fi
          elif [ "${{ env.status }}" == "merged" ]; then
            echo "‚ÑπÔ∏è Updating task ${{ env.ISSUE_KEY }} to 'Merged' status..."
            RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST "https://api.tracker.yandex.net/v2/issues/${{ env.ISSUE_KEY }}/transitions/merged/_execute" \
              -H "Authorization: OAuth ${{ secrets.YANDEX_TRACKER_TOKEN }}" \
              -H "X-Cloud-Org-ID: ${{ secrets.YANDEX_CLOUD_ORG_ID }}")

            if [ "$RESPONSE" -ne 200 ]; then
              echo "‚ùå Error updating task. Response code: $RESPONSE"
              cat response.txt
              exit 1
            else
              echo "‚úÖ Task updated to 'Merged' status successfully"
            fi
          fi
