name: Update Task Status on Merged

on:
  pull_request:
    types:
      - closed  # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ PR –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è (–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –æ–Ω —Å–ª–∏—Ç)
      - opened  # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ PR –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è

jobs:
  update-status:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check if PR Was Merged or Reopened
        id: check_merged_or_reopened
        run: |
          echo "üìå PR merged? ${{ github.event.pull_request.merged }}"
          echo "üìå PR action: ${{ github.event.action }}"

          # –ï—Å–ª–∏ PR –∑–∞–∫—Ä—ã—Ç, –Ω–æ –Ω–µ —Å–ª–∏—Ç, —Ç–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è
          if [[ "${{ github.event.pull_request.merged }}" != "true" ]]; then
            echo "‚ùå PR –∑–∞–∫—Ä—ã—Ç, –Ω–æ –Ω–µ –±—ã–ª —Å–ª–∏—Ç. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —à–∞–≥–æ–≤."
            echo "skip=true" >> $GITHUB_ENV  # –°—Ç–∞–≤–∏–º —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ PR –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–∫—Ä—ã—Ç
          if [[ "${{ github.event.action }}" == "opened" ]]; then
            echo "‚úÖ PR –±—ã–ª –æ—Ç–∫—Ä—ã—Ç –∑–∞–Ω–æ–≤–æ. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥."
            echo "skip=false" >> $GITHUB_ENV
          fi

      - name: Validate PR Title Format and Extract ISSUE_KEY
        id: check_pr_title
        shell: bash
        run: |
          echo "üìå Validating PR title: ${{ github.event.pull_request.title }}"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á –∑–∞–¥–∞—á–∏
          if [[ "${{ github.event.pull_request.title }}" =~ ^(REWIND-[1-9][0-9]*): ]]; then
            ISSUE_KEY="${BASH_REMATCH[1]}"
            echo "üîë Extracted ISSUE_KEY: $ISSUE_KEY"
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º ISSUE_KEY –≤ —Ñ–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
            echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
          else
            echo "‚ùå Invalid PR title format. Expected 'REWIND-{number}: description'"
            exit 1
          fi

      - name: Debug Issue Key
        run: |
          echo "üîë Extracted ISSUE_KEY: ${{ env.ISSUE_KEY }}"  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ISSUE_KEY –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è

      - name: Update Task Status to "Merged"
        if: env.skip != 'true'  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —à–∞–≥, –µ—Å–ª–∏ PR –Ω–µ –±—ã–ª —Å–ª–∏—Ç –∏–ª–∏ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç –∑–∞–Ω–æ–≤–æ
        shell: bash
        run: |
          if [ -z "${{ env.ISSUE_KEY }}" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: ISSUE_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi

          echo "‚ÑπÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ ${{ env.ISSUE_KEY }} –¥–æ —Å—Ç–∞—Ç—É—Å–∞ 'Merged'..."

          # –ó–¥–µ—Å—å –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ API Yandex Tracker –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST "https://api.tracker.yandex.net/v2/issues/${{ env.ISSUE_KEY }}/transitions/merged/_execute" \
            -H "Authorization: OAuth ${{ secrets.YANDEX_TRACKER_TOKEN }}" \
            -H "X-Cloud-Org-ID: ${{ secrets.YANDEX_CLOUD_ORG_ID }}")

          if [ "$RESPONSE" -ne 200 ]; then
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏. –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: $RESPONSE"
            cat response.txt
            exit 1
          else
            echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ ${{ env.ISSUE_KEY }} –¥–æ 'Merged'"
          fi
